library(httr)
FSID = function(InputDate){
  source = users %>% pull(source) %>% as.character()
  id     = users %>% pull(id)
  utoken = users %>% pull(access_token)
  #InputDate = "2021-05-10"
  url1    = "https://api.fitbit.com/1/user/"
  url2    = "/foods/log/date/"
  udate  = InputDate
  filetype= ".json"
  
  gets = function(fitId){
    url = paste0(url1, fitId, url2, udate, filetype)
    req = httr::GET(url,
                    add_headers(Authorization = paste0("Bearer ", unique(utoken[users$id ==fitId]))))
    dd  =httr::content(req, type = "application/json")
    dd$`foods`
  }
  getsD <- lapply(id, gets)
  names(getsD) <- source
  getsD=compact(getsD)
  source=names(getsD)
  
  fsget = function(x){
    dplyr::bind_rows(
      lapply(1:length(getsD[[x]]), function(y){
        getsD[[x]][[y]][["nutritionalValues"]] %>% unlist() %>%
          matrix(., ncol = 6, byrow = TRUE) %>%
          tibble(`calories`=.[,1], `carbs`=.[,2], `fat`=.[,3],`fiver`=.[,4],`protein`=.[,5],`sodium`=.[,6]) %>%
          mutate(names = getsD[[x]][[y]]$loggedFood$name) %>%
          select(names, calories, carbs, fat, fiver, protein, sodium)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
      })
    )
  }
  
  
  fsGetsfoodsDay = lapply(source, fsget)
  names(fsGetsfoodsDay) = source
  
  gg = dplyr::bind_rows(fsGetsfoodsDay,.id ='source')
  return(gg)
}
