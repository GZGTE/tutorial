library(lubridate)
library(httr)

SSID = function(InputDate1, InputDate2){
  source = users %>% pull(source) %>% as.character()
  id     = users %>% pull(id)
  utoken = users %>% pull(access_token)
  
  #InputDate1 = "2021-04-18"
  #InputDate2 = "2021-04-21"
  url1    = "https://api.fitbit.com/1.2/user/"
  url2    = "/sleep/date/"
  udate1  = InputDate1
  udate2  = InputDate2
  filetype= ".json"
  
  gets = function(fitId){
    url = paste0(url1, fitId, url2, udate1, "/", udate2, filetype)
    req = httr::GET(url,
                    add_headers(Authorization = paste0("Bearer ", unique(utoken[users$id ==fitId]))))
    dd  =httr::content(req, type = "application/json")
    dd$`sleep`
  }
  getsD <- lapply(id, gets)
  names(getsD) <- source
  getsD=compact(getsD)
  source=names(getsD)
  
  ssget = function(x){
   dplyr::bind_rows(
    lapply(1:length(getsD[[x]]), function(y){
      getsD[[x]][[y]]$levels$data%>%unlist()%>%
        matrix(., ncol=3, byrow = TRUE) %>%
        tibble(`time` = .[,1], `stage`=.[,2], `length`=.[,3], `group`=y)%>%
        mutate(ymdhms = ymd_hms(time)) %>%
        select(ymdhms, stage, length, group)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
    })
   )
  }
  ssGetsIntraDay = lapply(source, ssget)
  names(ssGetsIntraDay) = source
  
  gg = dplyr::bind_rows(ssGetsIntraDay,.id ='source')
  return(gg)
     
}
